# Всем привет! :)

В этом проекте мы будем считать размер выборки для проведения A/B тестирования.

## «Классический» подход и калькуляторы размера выборки

Одна из самых популярных формул для расчёта необходимого размера выборки в A/B-тесте:

$$
n > \frac{\left[\Phi^{-1}(1 - \alpha/2) + \Phi^{-1}(1 - \beta)\right]^2 (\sigma_X^2 + \sigma_Y^2)}{\epsilon^2}
$$

### Пояснение параметров:

| Параметр | Описание |
|----------|----------|
| **α** | Вероятность ошибки первого рода (уровень значимости). Обычно задаётся от `0.001` до `0.05`. |
| **β** | Вероятность ошибки второго рода. Часто берётся равной `0.1` или `0.2`. |
| **σₓ, σᵧ** | Стандартные отклонения метрики в контрольной и тестовой группах. Оцениваются по историческим данным. |
| **ε** | Ожидаемый эффект, например, увеличение CTR на `0.01`. |
| **Φ⁻¹** | Обратная функция стандартного нормального распределения (Z-оценка). |

---

### Что означает формула?

Эта формула рассчитывает **минимальное количество наблюдений на группу**, необходимое для обнаружения эффекта `ε` с заданной **мощностью** и **уровнем значимости**.

---

### Основные допущения:

- Данные в группах распределены **нормально**.
- Тест предполагает использование **t-теста** или Z-теста.
- Дисперсии в группах **постоянны и известны**.

---

### Важные выводы:

Из формулы можно сделать несколько интуитивно понятных выводов:

1. **Чем выше дисперсия** → тем **больше пользователей нужно** для обнаружения эффекта.
2. **Чем меньше эффект (ε)** → тем **длиннее тест** и тем больше наблюдений требуется.
3. **Чем строже требования к ошибкам (меньше α и β)** → тем **больше выборка** нужна.

---

### Важно понимать

Несмотря на популярность этой формулы, она **основана на ряде допущений**, которые не всегда выполняются на практике:
- Нормальность данных — в реальности редко встречается.
- Известная дисперсия — на практике оценивается с погрешностью.
- Фиксированный размер эффекта — в реальности может меняться.

Тем не менее, формула часто используется в онлайн-калькуляторах и помогает получить **приблизительную оценку** необходимого размера выборки.

---

### Пример интерпретации

> Мы хотим обнаружить увеличение CTR на 0.01 с вероятностью ошибки первого рода `α = 0.05` и второго рода `β = 0.1`.  
> Используя исторические данные, мы оценили дисперсии в группах и подставили значения в формулу.  
> Полученный размер выборки говорит нам, **сколько пользователей нужно** в каждой группе, чтобы тест имел достаточную мощность.

## Оценка размера выборки методом Монте-Карло

Когда классические формулы требуют слишком много допущений, на помощь приходит **имитационный подход**, основанный на методе **Монте-Карло**.  
Этот метод позволяет оценить необходимый размер выборки без строгих предположений о распределении данных.

---

### Как это работает?

1. **Подготовка данных:**
   - Берём исторические данные или данные из A/A теста.
   - Делим пользователей на две статистически эквивалентные группы: A и B.

2. **Симуляция эффекта:**
   - В группе A искусственно добавляем ожидаемый эффект.
   - Например, увеличиваем метрику на 1% для всех пользователей (подходит, если эффект равномерен).
   - Важно: этот способ работает, если эффект равномерно влияет на пользователей. Если он касается только определённой аудитории — нужно учесть это в симуляции.

3. **Проведение синтетических тестов:**
   - Фиксируем число итераций, например, `N = 1000`.
   - Выбираем начальный размер выборки, например, `n = 500`.
   - На каждой итерации:
     - Случайно семплируем `n` пользователей из модифицированной группы A и оригинальной группы B.
     - Проводим статистический тест (например, t-тест или тест Манна-Уитни).
     - Фиксируем, сколько раз тест показал значимость.

4. **Оценка мощности:**
   - Если доля значимых тестов **меньше заданной мощности** (например, 80%), увеличиваем `n`.
   - Если **больше** — можно попробовать уменьшить размер выборки.

---

### Преимущества метода:

- Не требует нормальности данных.
- Учитывает реальное распределение метрики.
- Позволяет учесть **неравномерное влияние** эксперимента (в отличие от классической формулы).

---

### Пример симуляции в нашем проекте:

В ходе эксперимента был реализован следующий подход:

1. **Генерация просмотров:**
   - Сэмплировали количество просмотров на пользователя из реальных данных.

2. **Генерация CTR:**
   - CTR каждого пользователя брали из реального распределения.
   - Использовали его как вероятность клика.

3. **Генерация кликов:**
   - Для каждого пользователя моделировали клики с помощью **биномиального распределения**:
     ```python
     clicks = np.random.binomial(n=views, p=ctr, size=n_users)
     ```

4. **Анализ:**
   - Проводили симуляции с разным размером выборки.
   - Оценивали, насколько часто тест обнаруживает введённый эффект.

---

### Зачем это нужно?

Метод Монте-Карло позволяет:
- Получить **реалистичную оценку размера выборки**, учитывающую специфику продукта.
- Учесть **неравномерное влияние** эксперимента на пользователей.
- Избежать ошибок, связанных с **ненормальностью данных** и неточными оценками дисперсии.

---

### Вывод

Метод Монте-Карло — мощный инструмент для оценки необходимого размера выборки. Он особенно полезен, когда:
- Распределение метрики неизвестно или не нормально.
- Эффект неравномерен.
- Требуется точная оценка мощности теста.

Этот подход позволяет заранее понять, сколько пользователей нужно для достоверного A/B-теста, и минимизировать риск ложных выводов.

### Описание данных:
  
## Таблица feed_actions (База данных новостной ленты)

* **user_id** - Уникальный номер пользователя

* **post_id** - Уникальный номер поста

* **acion** - Дейстиве пользователя
  * **like** - Поставить лайк на пост
  * **view** - Просмотреть пост
* **time** – дата совершения события

* **gender** - Гендер пользователя
  * **0** - Мужчина
  * **1** - Женщина
* **age** - Возраст пользователя

* **country** - Страна пользователя

* **city** - Город пользователя

* **os** - Операционная система пользователя
  * **iOS** - iOS
  * **Android** - Android
* **source** - Тип трафика

  * **ads** - Рекламный пользователь
  * **organic** - Органический пользователь

* **exp_group** - Номер экспериментальной группы пользователя в A/B-тесте
